<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de AdministraciÃ³n - Datos QR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #07599C;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: #0B8BF4;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-refresh {
            background: #28a745;
            color: white;
        }

        .btn-refresh:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .count {
            font-size: 1.1em;
            color: #495057;
            font-weight: 600;
        }

        .count span {
            color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            padding: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #054070;
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        tbody tr:hover {
            background: #c9c9c9;
            transition: background 0.5s ease;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            font-size: 1.2em;
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .json-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .json-cell:hover {
            white-space: normal;
            word-break: break-all;
        }

        .object-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: monospace;
            font-size: 0.9em;
        }

        .object-cell:hover {
            white-space: normal;
            word-break: break-all;
        }

        .boolean-cell {
            text-align: center;
        }

        .boolean-true {
            color: #28a745;
            font-weight: bold;
        }

        .boolean-false {
            color: #dc3545;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Panel de administrador</h1>
            <p>Registros de escaneos QR</p>
        </div>
        
        <div class="controls">
            <div class="count">
                Total de registros: <span id="totalCount">0</span>
            </div>
            <button class="btn btn-refresh" onclick="loadData()">Actualizar</button>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">Cargando datos...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="empty" class="empty" style="display: none;">
                <div class="empty-icon">ðŸ“­</div>
                <p>No hay registros disponibles</p>
            </div>
            <table id="dataTable" style="display: none;">
                <thead id="tableHead">
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function getAllKeys(data) {
            const keys = new Set();
            data.forEach(item => {
                Object.keys(item).forEach(key => keys.add(key));
            });
            return Array.from(keys).sort();
        }

        function formatCellValue(value, key) {
            if (value === null || value === undefined) {
                return 'N/A';
            }

            if (typeof value === 'object' && !Array.isArray(value)) {
                return JSON.stringify(value);
            }

            if (Array.isArray(value)) {
                return JSON.stringify(value);
            }

            if (typeof value === 'boolean') {
                return value ? '<span class="boolean-true">âœ“ SÃ­</span>' : '<span class="boolean-false">âœ— No</span>';
            }

            if (key === 'date' && typeof value === 'string') {
                try {
                    return new Date(value).toLocaleString('es-ES');
                } catch (e) {
                    return value;
                }
            }

            return String(value);
        }

        function getCellClass(value, key) {
            if (value === null || value === undefined) {
                return '';
            }

            if (typeof value === 'boolean') {
                return 'boolean-cell';
            }

            if (typeof value === 'object') {
                return 'object-cell';
            }

            if (key === 'userAgent' && String(value).length > 50) {
                return 'json-cell';
            }
            return '';
        }

        function getCellTitle(value, key) {
            if (typeof value === 'object' && value !== null) {
                return JSON.stringify(value, null, 2);
            }
            if (String(value).length > 50) {
                return String(value);
            }
            return '';
        }

        function formatColumnName(key) {
            const names = {
                'date': 'Fecha',
                'userAgent': 'User Agent',
                'language': 'Idioma',
                'platform': 'Plataforma',
                'cpuCores': 'NÃºcleos CPU',
                'memoryGB': 'Memoria (GB)',
                'online': 'En LÃ­nea',
                'screenResolution': 'ResoluciÃ³n Pantalla',
                'windowSize': 'TamaÃ±o Ventana',
                'connection': 'ConexiÃ³n',
                'dateTime': 'Fecha/Hora',
                'browser': 'Navegador',
                'ipPublica': 'IP PÃºblica'
            };
            return names[key] || key.charAt(0).toUpperCase() + key.slice(1);
        }

        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const empty = document.getElementById('empty');
            const table = document.getElementById('dataTable');
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const totalCount = document.getElementById('totalCount');

            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';

            try {
                const response = await fetch('/data');
                
                if (!response.ok) {
                    throw new Error('Error al obtener los datos');
                }

                const data = await response.json();
                
                loading.style.display = 'none';
                totalCount.textContent = data.length;

                if (data.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                const allKeys = getAllKeys(data);

                tableHead.innerHTML = '<tr>' + allKeys.map(key => 
                    `<th>${formatColumnName(key)}</th>`
                ).join('') + '</tr>';

                tableBody.innerHTML = '';

                const sortedData = data.sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA;
                });

                sortedData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    allKeys.forEach(key => {
                        const cell = document.createElement('td');
                        const value = item[key];
                        const formattedValue = formatCellValue(value, key);
                        const cellClass = getCellClass(value, key);
                        const cellTitle = getCellTitle(value, key);
                        
                        cell.className = cellClass;
                        if (cellTitle) {
                            cell.title = cellTitle;
                        }
                        cell.innerHTML = formattedValue;
                        
                        row.appendChild(cell);
                    });

                    tableBody.appendChild(row);
                });

                table.style.display = 'table';
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `Error: ${err.message}`;
            }
        }
        loadData();
        setInterval(loadData, 5000);
    </script>
</body>
</html>
